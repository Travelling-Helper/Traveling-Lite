<!--
@author Yichen Han, Surong Huang, Yuqi Hu
@date Nov. 16 2020
@version version 4.2

JS API key = 4e8abd261bb57fbaeffc6756e3e7f8c3
Test Web = http://150.158.153.253:8080/maps/test
         = "python manage.py runserver" + http://127.0.0.1:8000/maps/test

Reference:
https://lbs.amap.com/api/javascript-api/example/map/map-english

Note:
    .H = helper function

Structure:
  < HEAD >
    1 style
      (NEW: START & END RADIO)
  < BODY >
    2 containers
      (NEW: START & END RADIO)
    3 javascript
      3.1 variables
      3.2 functions
          3.2.0 constructor of linked list
          3.2.1 construct map
                3.2.1.0 map
              //3.2.1.1 language
          3.2.2 search, add, remove a poi
                3.2.2.0 search
                3.2.2.1 add
                3.2.2.2 remove
                3.2.2.H clear search box
                3.2.2.H copy poi infos from list to containers
                3.2.2.H Update start poi check box when a poi is deleted
                3.2.2.H Update end poi check box when a poi is deleted
          3.2.3 search all pois
                3.2.3.1 route (NEW: UPDATE START POI INDEX)
                3.2.3.2 cluster
          3.2.4 clear all pois
          3.2.X test functions
-->

<!DOCTYPE html>
<html lang="zh-CN">

{% load static %}

<title>ÊàëÊª¥ËßÑËßÑüõ∏</title>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>ËæìÂÖ•Ê°ÜÈÄâÊã©POIÁÇπ</title>
    <!-- ‰∏≠Ëã±ÊñáÂàáÊç¢ -->
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <!-- ‰ΩøÁî® KEY Ë∞ÉÁî® JS API -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.8&key=4e8abd261bb57fbaeffc6756e3e7f8c3"></script>
    <!-- UIÁªÑ‰ª∂Â∫ì -->
    <script src="//webapi.amap.com/ui/1.1/main.js?v=1.1.1"></script>
    <!-- Ë∑ØÁ∫øÊòæÁ§∫ -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=4e8abd261bb57fbaeffc6756e3e7f8c3&plugin=AMap.Driving"></script>
    <!-- ‰∏≠Ëã±ÊñáÂØπÁÖß -->
    <script src="https://cache.amap.com/lbs/static/es5.min.js"></script>
    <!-- JQUERY-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <!-- PART 1 STYLE-->
    <style>
        html,
        body,

        /* 1: Map */
        #container { width: 100%; height: 100%; left: 375px; font-size: 13px; user-select: none;}

        /*6ÔºöÊêúÁ¥¢ÊåâÈíÆ*/
        #searchButton        { position: absolute; top: 25px; left: 30px; height: 25px; width: 100px; background:#4994fc; border:none; color:#ffffff; }
        #searchButtonCluster { position: absolute; top: 25px; left: 130px; height: 25px; width: 100px; background:#9d69ff; border:none; color:#ffffff; }

        /* 2: Search Box */
        #pickerBox { position: absolute; top: 60px; left: 30px; width: 300px; }
        #pickerInput { width: 200px; padding: 5px 5px; }
        #poiInfo { background: #fff; }
        .amap_lib_placeSearch .poibox.highlight {
            background-color: #CAE1FF;
        }
        .amap_lib_placeSearch .poi-more {
            display: none!important;
        }

        /* 2.5: Clear Search Box */
        #clearSearchBox { position: absolute; top: 60px; left: 230px; height: 33px; }

        /*7ÔºöClear All Pois */
        #clearButton { position: absolute; top: 120px; left: 30px; height: 25px; border-bottom-style:solid; border-right-style:solid; background:#fadede; border-bottom-width:thin; border-bottom-color:#ffcccc; border-right-width:thin; border-right-color:#ffcccc; border-top-width:thin; border-top-color:#ffcccc; border-left-width:thin; border-left-color:#ffcccc;}

        /* 3: Add Position Button (REMOVED) */
        #addButton { position: absolute; top: 50px; left: 290px; height: 30px; width: 100px; }

        /* 4ÔºöPosition Boxes ‰πù‰∏™Âú∞ÂùÄÊ†è */
        #poiContainer1 { position: absolute; top: 150px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer2 { position: absolute; top: 190px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer3 { position: absolute; top: 230px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer4 { position: absolute; top: 270px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer5 { position: absolute; top: 310px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer6 { position: absolute; top: 350px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer7 { position: absolute; top: 390px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer8 { position: absolute; top: 430px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #poiContainer9 { position: absolute; top: 470px; left: 30px; height: 30px; width:175px; background: #ffffff; border-style:none; border-bottom-style:solid; border-bottom-width:thin; border-bottom-color:#B0C4DE; line-height: 27px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /*5Ôºö‰πù‰∏™Âà†Èô§ÊåâÈíÆ*/
        #deleteButton1 { position: absolute; top: 150px; left: 330px; height: 30px; }
        #deleteButton2 { position: absolute; top: 190px; left: 330px; height: 30px; }
        #deleteButton3 { position: absolute; top: 230px; left: 330px; height: 30px; }
        #deleteButton4 { position: absolute; top: 270px; left: 330px; height: 30px; }
        #deleteButton5 { position: absolute; top: 310px; left: 330px; height: 30px; }
        #deleteButton6 { position: absolute; top: 350px; left: 330px; height: 30px; }
        #deleteButton7 { position: absolute; top: 390px; left: 330px; height: 30px; }
        #deleteButton8 { position: absolute; top: 430px; left: 330px; height: 30px; }
        #deleteButton9 { position: absolute; top: 470px; left: 330px; height: 30px; }

        /* 8 Ëµ∑ÁÇπRadio */
        #startPoi0 { position: absolute; top: 120px; left: 243px; height: 30px; }
        #startPoi1 { position: absolute; top: 150px; left: 243px; height: 30px; }
        #startPoi2 { position: absolute; top: 190px; left: 243px; height: 30px; }
        #startPoi3 { position: absolute; top: 230px; left: 243px; height: 30px; }
        #startPoi4 { position: absolute; top: 270px; left: 243px; height: 30px; }
        #startPoi5 { position: absolute; top: 310px; left: 243px; height: 30px; }
        #startPoi6 { position: absolute; top: 350px; left: 243px; height: 30px; }
        #startPoi7 { position: absolute; top: 390px; left: 243px; height: 30px; }
        #startPoi8 { position: absolute; top: 430px; left: 243px; height: 30px; }
        #startPoi9 { position: absolute; top: 470px; left: 243px; height: 30px; }

        /* 9 ÁªàÁÇπRadio */
        #endPoi0 { position: absolute; top: 120px; left: 293px; height: 30px; }
        #endPoi1 { position: absolute; top: 150px; left: 293px; height: 30px; }
        #endPoi2 { position: absolute; top: 190px; left: 293px; height: 30px; }
        #endPoi3 { position: absolute; top: 230px; left: 293px; height: 30px; }
        #endPoi4 { position: absolute; top: 270px; left: 293px; height: 30px; }
        #endPoi5 { position: absolute; top: 310px; left: 293px; height: 30px; }
        #endPoi6 { position: absolute; top: 350px; left: 293px; height: 30px; }
        #endPoi7 { position: absolute; top: 390px; left: 293px; height: 30px; }
        #endPoi8 { position: absolute; top: 430px; left: 293px; height: 30px; }
        #endPoi9 { position: absolute; top: 470px; left: 293px; height: 30px; }

        #startText { position: absolute; top: 100px; left: 236px; font-weight:bold }
        #endText   { position: absolute; top: 100px; left: 287px; font-weight:bold }
        #startNull { position: absolute; top: 119px; left: 226px; line-height: 30px; }
        #endNull   { position: absolute; top: 119px; left: 276px; line-height: 30px; }
    </style>
</head>








<body>
<!--PART 2 CONTAINERS-->

<!-- 1 Âú∞ÂõæÂÆπÂô® -->
<div id="container" class="map" tabindex="0"></div>
<!-- 1.1 ÈÄâÊã©Âú∞ÂõæËØ≠Ë®Ä -->
<!--<div class="input-card" style="width:15rem">-->
<!--    <h4>Â∫ïÂõæËØ≠Ë®ÄÂàáÊç¢</h4>-->
<!--    <div id="lang">-->
<!--        <div class="input-item"><input id="zh_cn" name="language" type="radio"  checked="checked"><span class="input-text">‰∏≠ÊñáÂú∞Âõæ</span></div>-->
<!--        <div class="input-item"><input id="zh_en" name="language" type="radio"><span class="input-text">‰∏≠Êñá-English ÂØπÁÖß</span></div>-->
<!--        <div class="input-item"><input id="en" name="language" type="radio"><span class="input-text">English Map</span></div>-->
<!--    </div>-->
<!--</div>-->

<!-- 2 ÊêúÁ¥¢Ê°ÜÂÆπÂô® -->
<div id="pickerBox">
    <input id="pickerInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆÂ≠óÈÄâÂèñÂú∞ÁÇπ" value="" style="width:150pt;height:25pt"/>
    <div id="poiInfo"></div>
</div>
<!-- 2.1 Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü -->
<button id="clearSearchBox" onclick="clearSearchBox()" style="width:34px;height:34px;background-color:#e1f2f5;border:none;border-bottom-style:solid; border-right-style:solid; border-bottom-width:thin; border-bottom-color:#e6ffff; border-right-width:thin; border-right-color:#e6ffff; border-top-width:thin; border-top-color:#e6ffff; border-left-width:thin; border-left-color:#e6ffff;"><i style="font-style:normal;font-size:15pt;line-height:20px;">√ó</i></button>

<!-- 3 Ê∑ªÂä†ÊåâÈíÆÂÆπÂô® -->
<!--<button id="addButton" onclick="addPoi()"><i>Ê∑ªÂä†ËØ•Âú∞ÁÇπ</i></button>-->

<!-- 4 ‰πù‰∏™Âú∞ÂùÄÊ†èÂÆπÂô® -->
<div><i id="poiContainer1" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer2" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer3" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer4" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer5" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer6" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer7" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer8" hidden style="font-style:normal;"></i></div>
<div><i id="poiContainer9" hidden style="font-style:normal;"></i></div>

<!-- 5 ‰πù‰∏™Âà†Èô§ÊåâÈíÆÂÆπÂô® -->
<button id="deleteButton1" onclick="deletePoi(1)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton2" onclick="deletePoi(2)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton3" onclick="deletePoi(3)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton4" onclick="deletePoi(4)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton5" onclick="deletePoi(5)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton6" onclick="deletePoi(6)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton7" onclick="deletePoi(7)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton8" onclick="deletePoi(8)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>
<button id="deleteButton9" onclick="deletePoi(9)" hidden style="background-color: #ffffff; border:none"><i style="font-style:normal;font-size:12pt;">&#128465;</i></button>

<!-- 6 ÊêúÁ¥¢ÊåâÈíÆÂÆπÂô® -->
<button id="searchButton" onclick="search()"><i style="font-style:normal;">&#128269;&nbsp;ÁúÅÊó∂Ë∑ØÂæÑ</i></button>
<!-- 6.5 ËÅöÁ±ªÊêúÁ¥¢Ë∑ØÂæÑ-->
<button id="searchButtonCluster" onclick="alertCluster()"><i style="font-style:normal;">&#128269;&nbsp;Âú∞ÁÇπÂàÜÁªÑ</i></button>

<!-- 7 Ê∏ÖÁ©∫Âú∞ÁÇπ -->
<button id="clearButton" onclick="clearPois()"><i style="font-style:normal;">ÈáçÁΩÆ</i></button>

<!-- 8.1 Start Poi -->
<div>
    <input type="radio" id="startPoi0" name="startPoi" value=0 checked>
    <input type="radio" id="startPoi1" name="startPoi" value=1 hidden>
    <input type="radio" id="startPoi2" name="startPoi" value=2 hidden>
    <input type="radio" id="startPoi3" name="startPoi" value=3 hidden>
    <input type="radio" id="startPoi4" name="startPoi" value=4 hidden>
    <input type="radio" id="startPoi5" name="startPoi" value=5 hidden>
    <input type="radio" id="startPoi6" name="startPoi" value=6 hidden>
    <input type="radio" id="startPoi7" name="startPoi" value=7 hidden>
    <input type="radio" id="startPoi8" name="startPoi" value=8 hidden>
    <input type="radio" id="startPoi9" name="startPoi" value=9 hidden>
</div>

<!-- 8.2 End Poi Radio -->
<div>
    <input type="radio" id="endPoi0" name="endPoi" value=0 checked>
    <input type="radio" id="endPoi1" name="endPoi" value=1 hidden>
    <input type="radio" id="endPoi2" name="endPoi" value=2 hidden>
    <input type="radio" id="endPoi3" name="endPoi" value=3 hidden>
    <input type="radio" id="endPoi4" name="endPoi" value=4 hidden>
    <input type="radio" id="endPoi5" name="endPoi" value=5 hidden>
    <input type="radio" id="endPoi6" name="endPoi" value=6 hidden>
    <input type="radio" id="endPoi7" name="endPoi" value=7 hidden>
    <input type="radio" id="endPoi8" name="endPoi" value=8 hidden>
    <input type="radio" id="endPoi9" name="endPoi" value=9 hidden>
</div>

<!-- 8.3 Start & End Text-->
<div>
    <i id="startText" style="font-style:normal;">Ëµ∑ÁÇπ</i>
    <i id="endText" style="font-style:normal;">ÁªàÁÇπ</i>
    <i id="startNull" style="font-style:normal;">Êó†</i>
    <i id="endNull" style="font-style:normal;">Êó†</i>
</div>








<!-- PART 3 FUNCTIONS (JS) -->
<script type="text/javascript">

    /* 3.1 VARIABLES */
    var totalPoiNum = 0;            // Total # of Positions Have Added (0 to 9)
    var currentPoiInfo = "";        // Current Position Information
    var currentPoiInfoDisplay = ""; // Current Position Information (Shortened)
    var positionsInfo = "";         // Concatenated String of Positions to RETURN
    var cluster = 0;                /* >0: Cluster
                                        0: No Start + No End
                                       -1:    Start + No End
                                       -2: No Start +    End
                                       -3:    Start +    End */
    var start_index_var = 0;        // Index of Start Position (0 for DNE)
    var end_index_var = 0;          // Index of End   Position (0 for DNE)





    /* 3.2 FUNCTIONS */

    /* 3.2.0 Constructor of Position Information Boxes */
    function createNode () {
        this.info = null;
        this.infoDisplay = null;
        this.nextNode = null;
        this.prevNode = null;
    }
    // Construct Position Information Box Objects in Node Data-structure
    var dummyFirstNode = new createNode();
    var lastNode = dummyFirstNode;



    /* 3.2.1 Basic Map Construction */
    // 3.2.1.0 ÁîüÊàêÂú∞Âõæ
    var map = new AMap.Map('container', {
        zoom: 10,
        lang: "zh_cn",
        resizeEnable: true
    });


    // 3.2.1.1 Switch Languages (REMOVED)
    var radios = document.querySelectorAll("#lang input");
    radios.forEach(function(ratio) {
        ratio.onclick = setLang;
    });
    function setLang() {
        map.setLang(this.id);
    }



    /* 3.2.2 Search & Add & Remove Positions */
    // 3.2.2.0 Search a position
    AMapUI.loadUI(['misc/PoiPicker'], function(PoiPicker) {

        var poiPicker = new PoiPicker({
            //city:'Âåó‰∫¨',
            input: 'pickerInput'
        });

        //ÂàùÂßãÂåñpoiPicker
        poiPickerReady(poiPicker);
    });
    function poiPickerReady(poiPicker) {

        window.poiPicker = poiPicker;

        var marker = new AMap.Marker();

        var infoWindow = new AMap.InfoWindow({
            offset: new AMap.Pixel(0, -20)
        });

        //ÈÄâÂèñ‰∫ÜÊüê‰∏™POI
        poiPicker.on('poiPicked', function(poiResult) {

            var source = poiResult.source,
                poi = poiResult.item,
                // POI information
                info = {
                    id: poi.id,
                    name: poi.name,
                    location: poi.location.toString(),
                    address: poi.address
                };
            info2 = {
                name: poi.name,
                location: poi.location,
                address: poi.address
            }

            marker.setMap(map);
            marker.setPosition(poi.location); // ÂõæÈíâ
            infoWindow.setMap(map);
            infoWindow.setPosition(poi.location); // POI‰ø°ÊÅØÊ°Ü

            // ÊâìÂç∞‰ø°ÊÅØ
            //infoWindow.setContent('POI‰ø°ÊÅØ: <pre>' + JSON.stringify(info, null, 2) + '</pre>');
            infoWindow.open(map, marker.getPosition());

            // current POI info
            currentPoiInfo = JSON.stringify(info, null);
            var name = info2.name;
            var address = info2.address;
            currentPoiInfoDisplay = name;
            document.getElementById("pickerInput").value = name; // fill poi name to search box

            map.setZoomAndCenter(14, info2.location); // reset map center & scale
            addPoi();
        });

        //ÊêúÁ¥¢Êé®Ëçê
        poiPicker.onCityReady(function() {
            //poiPicker.suggest('ÁæéÈ£ü');
        });
    }


    // 3.2.2.1 Add a position
    function addPoi () {
        // Null Case
        if (totalPoiNum >= 9) {alert("ËØ∑ÂãøË∂ÖËøá‰πù‰∏™ÁÇπÔºÅ"); return;}
        if (currentPoiInfo == "") {return;}

        // Null Case: ÈáçÂ§çÂú∞ÁÇπ
        var currentNode = dummyFirstNode;
        for (var index = 1; index <= totalPoiNum; index++) {
            currentNode = currentNode.nextNode;
            if (currentNode.infoDisplay == currentPoiInfoDisplay) {
                alert ("ËØ∑ÂãøËæìÂÖ•Áõ∏ÂêåÂú∞ÁÇπÔºÅ");
                return;
            }
        }

        // Regular Case: js
        var newNode = new createNode();
        newNode.info = currentPoiInfo;
        newNode.infoDisplay = currentPoiInfoDisplay;
        newNode.prevNode = lastNode;
        lastNode.nextNode = newNode;
        lastNode = newNode;
        totalPoiNum++;

        // Regular Case: html
        connectPois();
    }


    // 3.2.2.2 Delete a position
    function deletePoi (idxToDelete) {
        // Null Case: no poi info
        if (idxToDelete > totalPoiNum) {return;}

        // Regular Case
        totalPoiNum--;
        var currentNode = dummyFirstNode;
        for (var index = 1; index <= idxToDelete; index++) {
            currentNode = currentNode.nextNode;
        }
        currentNode.prevNode.nextNode = currentNode.nextNode;
        if (currentNode.nextNode != null) {
            currentNode.nextNode.prevNode = currentNode.prevNode;
        }
        // update HTML
        connectPois();
        updateStart(idxToDelete);
        updateEnd(idxToDelete);

        // Update last node
        lastNode = dummyFirstNode;
        while (lastNode.nextNode != null) {
            lastNode = lastNode.nextNode;
        }
    }


    // 3.2.2.H Clear search box
    function clearSearchBox() {
        document.getElementById("pickerInput").value = "";
    }


    // 3.2.2.H Put poi info in linked node to poiContainer1~9 by traverse
    function connectPois () {
        // clear poiContainer1~9
        for (var index=1; index<10; index++) {
            document.getElementById("poiContainer" + index).innerText = "";
        }
        // start copy poi infos
        var currentNode = dummyFirstNode;
        var index = 1;
        // section 1: poiContainers with info
        while (index <= totalPoiNum) {
            currentNode = currentNode.nextNode;
            document.getElementById("poiContainer" + index).innerText = currentNode.infoDisplay; // poi info
            document.getElementById("poiContainer" + index).removeAttribute("hidden"); // not hide blue box
            document.getElementById("deleteButton" + index).removeAttribute("hidden"); // not hide delete button
            document.getElementById("startPoi"     + index).removeAttribute("hidden"); // not hide start poi radio
            document.getElementById("endPoi"       + index).removeAttribute("hidden"); // not hide end poi radio
            index++;
        }
        // section 2: poiContainers without info
        while (index <= 9) {
            document.getElementById("poiContainer" + index).innerText = ""; // no poi info
            document.getElementById("poiContainer" + index).setAttribute("hidden", true); // hide blue box
            document.getElementById("deleteButton" + index).setAttribute("hidden", true); // hide delete button
            document.getElementById("startPoi"     + index).setAttribute("hidden", true); // hind start poi radio
            document.getElementById("endPoi"       + index).setAttribute("hidden", true); // hind end poi radio
            index++;
        }
    }



    // 3.2.2.H Update start poi check box when a poi is deleted
    function updateStart (idxToDelete) {
        var startPoiInt = $('input[name="startPoi"]:checked').val();

        // case 1: no start poi: startPoiInt = 0
        if (startPoiInt == 0) {return;}

        // case 2: startPoiInt < idxToDelete
        if (startPoiInt < idxToDelete) {return;}

        // case 3: startPoiInt > idxToDelete
        if (startPoiInt > idxToDelete) {document.getElementById("startPoi"+(startPoiInt-1)).checked = true;}

        // case 4: startPoiInt = idxToDelete
        if (startPoiInt == idxToDelete) {document.getElementById("startPoi0").checked = true;}
    }

    // 3.2.2.H Update end poi check box when a poi is deleted
    function updateEnd (idxToDelete) {
        var endPoiInt = $('input[name="endPoi"]:checked').val();

        // case 1: no start poi: startPoiInt = 0
        if (endPoiInt == 0) {return;}

        // case 2: startPoiInt < idxToDelete
        if (endPoiInt < idxToDelete) {return;}

        // case 3: startPoiInt > idxToDelete
        if (endPoiInt > idxToDelete) {document.getElementById("endPoi"+(endPoiInt-1)).checked = true;}

        // case 4: startPoiInt = idxToDelete
        if (endPoiInt == idxToDelete) {document.getElementById("endPoi0").checked = true;}
    }




    /* 3.2.3 Search All Pois */

    // 3.2.3.1 Search quickest route
    function search() {
        positionsInfo = "";
        // Null Case: 0/1 poi
        if (totalPoiNum < 2) {alert("ËØ∑ËæìÂÖ•Ëá≥Â∞ë‰∏§‰∏™Âú∞ÁÇπÔºÅ"); return;}

        // Regular Case: concatenate infos
        var currentNode = dummyFirstNode;
        while (currentNode.nextNode != null) {
            currentNode = currentNode.nextNode;
            positionsInfo += currentNode.info;
        }
        document.getElementById("positionsToReturn").value = positionsInfo;
        document.getElementById("cluster").value = cluster;
        // ‚ùì ‚ùì ‚ùì Your code here to make start&end index ‚ùì ‚ùì ‚ùì
        start_index_var = $('input[name="startPoi"]:checked').val() - 1;
        end_index_var = $('input[name="endPoi"]:checked').val() - 1;
        document.getElementById("start_index").value = start_index_var;
        document.getElementById("end_index").value = end_index_var;

        var form = document.getElementById("pois");
        form.submit();
    }


    // 3.2.3.2 Search Cluster
    function alertCluster() {
        cluster = prompt("ËØ∑ËæìÂÖ•ÂàÜÁªÑÁöÑ‰∏™Êï∞Ôºö");
        // cluster > 0, cluster <= totalPoiNum
        if (cluster > 0 && cluster <= totalPoiNum) {
            search();
        }
        else {
            alert("ËØ∑ËæìÂÖ•Â§ß‰∫éÈõ∂‰∏î‰∏çÂ§ß‰∫éÂú∞ÁÇπÊÄªÊï∞ÁöÑÊï¥Êï∞ÔºÅ")
            alertCluster();
        }
    }





    /* 3.2.4 Ê∏ÖÁ©∫ÊâÄÊúâÂú∞ÁÇπ */
    function clearPois() {
        totalPoiNum = 0;
        dummyFirstNode.nextNode = null;
        lastNode = dummyFirstNode;
        connectPois();
    }





    /* 3.2.X ÊµãËØïÁî®ÁöÑÂáΩÊï∞ */
    function alertPoi() {
        var currentNode = dummyFirstNode;
        while (currentNode.nextNode != null) {
            currentNode = currentNode.nextNode;
            alert(currentNode.info);
        }
    }

    function separationDisplay() {
        var func_INFO = {{ FUNC }};
        if (func_INFO == 0) {
            // alert("Successful!!! This should be removed after TESTING");
        } else if (func_INFO == -1) {
            // alert("Error!!! This should be removed after TESTING");
            alert("Errcode: a000001ÔºåËØ∑Âà∞ËØ•ÁΩëÁ´ôÁïôË®Ä„ÄÇ");
        } else if (func_INFO == 1) {
            shortestPathDisplay();
        } else if (func_INFO == 2) {
            clusteringDisplay();
        } else {
            // alert("ERRORING IN FUNC INFO This should be removed after TESTING");
            alert("Errcode: a000002ÔºåËØ∑Âà∞ËØ•ÁΩëÁ´ôÁïôË®Ä„ÄÇ");
        }
    }

    window.onload = separationDisplay();

    //  üëá CLUSTER üëá CLUSTER üëá CLUSTER üëá CLUSTER üëá CLUSTER üëá CLUSTER üëá CLUSTER üëá CLUSTER üëá CLUSTER
    var center = null;
    var centerText = null;
    var setFitViewBtn = null;
    function clusteringDisplay() {

        var pic1 = "{% static 'img/map_icon/1.png' %}";
        var pic2 = "{% static 'img/map_icon/2.png' %}";
        var pic3 = "{% static 'img/map_icon/3.png' %}";
        var pic4 = "{% static 'img/map_icon/4.png' %}";
        var pic5 = "{% static 'img/map_icon/5.png' %}";
        var pic6 = "{% static 'img/map_icon/6.png' %}";
        var pic7 = "{% static 'img/map_icon/7.png' %}";
        var pic8 = "{% static 'img/map_icon/8.png' %}";
        var pic9 = "{% static 'img/map_icon/9.png' %}";
        var icon_lst = [pic1, pic2, pic3, pic4, pic5, pic6, pic7, pic8, pic9];

        // Location List
        var loc_lst = '{{ Locs }}';
        loc_lst = eval(loc_lst);
        // Result Diction
        var result_diction = '{{ Paths }}';
        result_diction = JSON.parse(result_diction.replace(/&quot;/g,'"'));

        function cluster_test() {
            map.clearMap();  // Ê∏ÖÈô§Âú∞ÂõæË¶ÜÁõñÁâ©
            var markers = [];
            for (i = 0; i < Object.keys(result_diction).length; i++) {
                for (j = 0; j < result_diction[i].length; j++) {
                    markers.push({
                        icon: icon_lst[i],
                        position: loc_lst[result_diction[i][j]]
                    });
                };
            };
            // Ê∑ªÂä†‰∏Ä‰∫õÂàÜÂ∏É‰∏çÂùáÁöÑÁÇπÂà∞Âú∞Âõæ‰∏ä,Âú∞Âõæ‰∏äÊ∑ªÂä†n‰∏™ÁÇπÊ†áËÆ∞Ôºå‰Ωú‰∏∫ÂèÇÁÖß
            markers.forEach(function(marker) {
                new AMap.Marker({
                    map: map,
                    icon: marker.icon,
                    position: [marker.position[0], marker.position[1]],
                    offset: new AMap.Pixel(-13, -30)
                });
            });
            center = map.getCenter();
            centerText = 'ÂΩìÂâç‰∏≠ÂøÉÁÇπÂùêÊ†áÔºö' + center.getLng() + ',' + center.getLat();
            document.getElementById('centerCoord').innerHTML = centerText;
            document.getElementById('tips').innerHTML = 'ÊàêÂäüÊ∑ªÂä†‰∏â‰∏™ÁÇπÊ†áËÆ∞ÔºåÂÖ∂‰∏≠Êúâ‰∏§‰∏™Âú®ÂΩìÂâçÂú∞ÂõæËßÜÈáéÂ§ñÔºÅ';

            setFitViewBtn = document.getElementById('setFitView');
        }
        cluster_test();
        fit_view_quick();
    }

    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨, ‰ΩøÂú∞ÂõæËá™ÈÄÇÂ∫îÊòæÁ§∫Âà∞ÂêàÈÄÇÁöÑËåÉÂõ¥
    function fit_view_quick() {
        // Á¨¨‰∏Ä‰∏™ÂèÇÊï∞‰∏∫Á©∫ÔºåË°®ÊòéÁî®Âõæ‰∏äÊâÄÊúâË¶ÜÁõñÁâ© setFitview
        // Á¨¨‰∫å‰∏™ÂèÇÊï∞‰∏∫false, ÈùûÁ´ãÂç≥ÊâßË°å
        // Á¨¨‰∏â‰∏™ÂèÇÊï∞ËÆæÁΩÆ‰∏äÂ∑¶‰∏ãÂè≥ÁöÑÁ©∫ÁôΩ
        map.setFitView(null, false, [150, 60, 100, 60]);
        var newCenter = map.getCenter();
        document.getElementById('centerCoord').innerHTML = 'ÂΩìÂâç‰∏≠ÂøÉÁÇπÂùêÊ†áÔºö' + newCenter.toString();
        document.getElementById('tips').innerHTML = 'ÈÄöËøásetFitViewÔºåÂú∞ÂõæËá™ÈÄÇÂ∫îÊòæÁ§∫Âà∞ÂêàÈÄÇÁöÑËåÉÂõ¥ÂÜÖ,ÁÇπÊ†áËÆ∞Â∑≤ÂÖ®ÈÉ®ÊòæÁ§∫Âú®ËßÜÈáé‰∏≠ÔºÅ';
    };
    //  üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER üëÜ CLUSTER

    // üëá SHORTEST üëá SHORTEST üëá SHORTEST üëá SHORTEST üëá SHORTEST üëá SHORTEST üëá SHORTEST üëá SHORTEST
    function shortestPathDisplay(){
        var location_lst = eval('{{ Locs }}'); // TEST CASE: [[90.427281, 30.865042], [110.427281, 30.865042], [80.379028, 30.865042], [80.379028, 39.903719], [79.379028, 39.903719], [79.379028, 40.903719]]
        var order_lst = eval('{{ Paths }}'); // TEST CASE: [0, 1, 2, 3, 4, 5];

        var drivingOption = {
            policy: AMap.DrivingPolicy.LEAST_TIME, // ÂÖ∂ÂÆÉpolicyÂèÇÊï∞ËØ∑ÂèÇËÄÉ https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingPolicy
            ferry: 1, // ÊòØÂê¶ÂèØ‰ª•‰ΩøÁî®ËΩÆÊ∏°
            province: '‰∫¨', // ËΩ¶ÁâåÁúÅ‰ªΩÁöÑÊ±âÂ≠óÁº©ÂÜô
        }

        // ÊûÑÈÄ†Ë∑ØÁ∫øÂØºËà™Á±ª
        var driving = new AMap.Driving(drivingOption)

        var pre_order_lst = [];
        for (var order_lst_i = 0; order_lst_i < order_lst.length - 1; order_lst_i++) {
            pre_order_lst.push([location_lst[order_lst[order_lst_i]][0], location_lst[order_lst[order_lst_i]][1], location_lst[order_lst[order_lst_i + 1]][0], location_lst[order_lst[order_lst_i + 1]][1]]);
        }

        // If the start is the end, then the icon is noted as a start icon, here are the conditions
        var flagStartIsEnd = order_lst[0] == order_lst[order_lst.length - 1];
        var order_length_total = order_lst.length;

        function return_index(json_result) {
            var result_tuple = [json_result.origin.lng, json_result.origin.lat, json_result.destination.lng, json_result.destination.lat];
            var order_x = 0;
            for (var order_i = 0; order_i < pre_order_lst.length; order_i++) {
                if (pre_order_lst[order_i][0] == result_tuple[0] && pre_order_lst[order_i][1] == result_tuple[1] && pre_order_lst[order_i][2] == result_tuple[2] && pre_order_lst[order_i][3] == result_tuple[3]) {
                    order_x = order_i;
                    break;
                }
            }
            return order_x
        }

        for (var order_i = 1; order_i < order_lst.length; order_i++) {
            // Ê†πÊçÆËµ∑ÁªàÁÇπÁªèÁ∫¨Â∫¶ËßÑÂàíÈ©æËΩ¶ÂØºËà™Ë∑ØÁ∫ø
            var func_status = function(status, result) {
                // resultÂç≥ÊòØÂØπÂ∫îÁöÑÈ©æËΩ¶ÂØºËà™‰ø°ÊÅØÔºåÁõ∏ÂÖ≥Êï∞ÊçÆÁªìÊûÑÊñáÊ°£ËØ∑ÂèÇËÄÉ https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingResult
                if (status === 'complete') {
                    if (result.routes && result.routes.length) {
                        // ÁªòÂà∂Á¨¨‰∏ÄÊù°Ë∑ØÁ∫øÔºå‰πüÂèØ‰ª•ÊåâÈúÄÊ±ÇÁªòÂà∂ÂÖ∂ÂÆÉÂá†Êù°Ë∑ØÁ∫ø
                        var color_number = return_index(result);
                        drawRoute(result.routes[0], color_number);
                        log.success('ÁªòÂà∂È©æËΩ¶Ë∑ØÁ∫øÂÆåÊàê');
                    }
                } else {
                    log.error('Ëé∑ÂèñÈ©æËΩ¶Êï∞ÊçÆÂ§±Ë¥•Ôºö' + result)
                }
            }
            driving.search(new AMap.LngLat(location_lst[order_lst[order_i-1]][0], location_lst[order_lst[order_i-1]][1]), new AMap.LngLat(location_lst[order_lst[order_i]][0], location_lst[order_lst[order_i]][1]), func_status);
        }

        function drawRoute (route, color_num) {
            var path_color_lst = [['#ef4136', '#f7acbc'], ['#2b4490', '#33a3dc'], ['#f58220', '#fab27b'], ['#84bf96', '#cde6c7'], ['#ef5b9c', '#feeeed'], ['#33a3dc', '#90d7ec'], ['#ffd400', '#fcf16e'], ['#8552a1', '#afb4db'], ['#005831', '#45b97c']];

            // Ëß£ÊûêDrivingRouteÂØπË±°ÔºåÊûÑÈÄ†ÊàêAMap.PolylineÁöÑpathÂèÇÊï∞ÈúÄË¶ÅÁöÑÊ†ºÂºè
            // DrivingResultÂØπË±°ÁªìÊûÑÂèÇËÄÉÊñáÊ°£ https://lbs.amap.com/api/javascript-api/reference/route-search#m_DriveRoute
            function parseRouteToPath(route) {
                var path = []
                for (var i = 0, l = route.steps.length; i < l; i++) {
                    var step = route.steps[i]
                    for (var j = 0, n = step.path.length; j < n; j++) {
                        path.push(step.path[j])
                    }
                }
                return path
            }

            var path = parseRouteToPath(route)

            var icon_start_http = 'https://webapi.amap.com/theme/v1.3/markers/' + (color_num + 1) + '.png';
            var icon_end_http = 'https://webapi.amap.com/theme/v1.3/markers/' + (color_num + 2) + '.png';

            // If the start is the end, then the icon is noted as a start icon
            if (flagStartIsEnd && order_length_total == color_num + 2){
                icon_end_http = 'https://webapi.amap.com/theme/v1.3/markers/1.png';
            }

            var startMarker = new AMap.Marker({
                position: path[0],
                icon: icon_start_http, // 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                map: map
            })

            var endMarker = new AMap.Marker({
                position: path[path.length - 1],
                icon: icon_end_http, // https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                map: map
            })

            var routeLine = new AMap.Polyline({
                path: path,
                isOutline: true,
                outlineColor: path_color_lst[color_num][1],
                borderWeight: 2,
                strokeWeight: 5,
                strokeColor: path_color_lst[color_num][0],
                lineJoin: 'round'
            })

            routeLine.setMap(map)
            // Ë∞ÉÊï¥ËßÜÈáéËææÂà∞ÊúÄ‰Ω≥ÊòæÁ§∫Âå∫Âüü
            map.setFitView([ startMarker, endMarker, routeLine ])
        }
    }
    // üëÜ SHORTEST üëÜ SHORTEST üëÜ SHORTEST üëÜ SHORTEST üëÜ SHORTEST üëÜ SHORTEST üëÜ SHORTEST üëÜ SHORTEST
</script>


<form action="tested" method="post" id="pois">{% csrf_token %}
    <input type="hidden" id="positionsToReturn" name="positionsToReturn" value="">
    <input type="hidden" id="cluster" name="cluster" value="">
    <!-- ‚ùì ‚ùì ‚ùì Code here to make start&end index ‚ùì ‚ùì ‚ùì -->
    <input type="hidden" id="start_index" name="start_index" value="">
    <input type="hidden" id="end_index" name="end_index" value="">
</form>

</body>

</html>
