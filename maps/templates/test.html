<!--
@author Yichen Han, Surong Huang, Yuqi Hu
@date Oct. 17 2020
@version version 3.0

JS API key = 4e8abd261bb57fbaeffc6756e3e7f8c3
Test Web = http://150.158.153.253:8080/maps/test
-->

<!DOCTYPE html>
<html lang="zh-CN">

{% load static %}

<title>æˆ‘æ»´è§„è§„ğŸ›¸</title>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>è¾“å…¥æ¡†é€‰æ‹©POIç‚¹</title>
    <style>
        html,
        body,
            /* 1: Map */
        #container {
            width: 100%;
            height: 100%;
            margin: 0px;
            font-size: 13px;
        }

        /* 2: Search Box */
        #pickerBox {
            position: absolute;
            z-index: 9999;
            top: 50px;
            left: 30px;
            width: 300px;
        }
        #pickerInput {
            width: 200px;
            padding: 5px 5px;
        }
        #poiInfo {
            background: #fff;
        }
        .amap_lib_placeSearch .poibox.highlight {
            background-color: #CAE1FF;
        }
        .amap_lib_placeSearch .poi-more {
            display: none!important;
        }
        /* 2.5: Clear Search Box */
        #clearSearchBox {
            position: absolute;
            z-index: 9999;
            top: 50px;
            left: 243px;
            height: 30px;
=        }

        /* 3: Add Position Button */
        #addButton {
            position: absolute;
            z-index: 9999;
            top: 50px;
            left: 290px;
            height: 30px;
            width: 100px;
        }

        /* 4ï¼šPosition Boxes ä¹ä¸ªåœ°å€æ  */
        #poiContainer1 {
            position: absolute;z-index: 9999;top: 50px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer2 {
            position: absolute;z-index: 9999;top: 100px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer3 {
            position: absolute;z-index: 9999;top: 150px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer4 {
            position: absolute;z-index: 9999;top: 200px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer5 {
            position: absolute;z-index: 9999;top: 250px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer6 {
            position: absolute;z-index: 9999;top: 300px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer7 {
            position: absolute;z-index: 9999;top: 350px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer8 {
            position: absolute;z-index: 9999;top: 400px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }
        #poiContainer9 {
            position: absolute;z-index: 9999;top: 450px;right: 65px;height: 40px;width:300px;background: #CAE1FF;
        }

        /*5ï¼šä¹ä¸ªåˆ é™¤æŒ‰é’®*/
        #deleteButton1 {
            position: absolute;z-index: 9999;top: 50px;right: 20px;
        }
        #deleteButton2 {
            position: absolute;z-index: 9999;top: 100px;right: 20px;
        }
        #deleteButton3 {
            position: absolute;z-index: 9999;top: 150px;right: 20px;
        }
        #deleteButton4 {
            position: absolute;z-index: 9999;top: 200px;right: 20px;
        }
        #deleteButton5 {
            position: absolute;z-index: 9999;top: 250px;right: 20px;
        }
        #deleteButton6 {
            position: absolute;z-index: 9999;top: 300px;right: 20px;
        }
        #deleteButton7 {
            position: absolute;z-index: 9999;top: 350px;right: 20px;
        }
        #deleteButton8 {
            position: absolute;z-index: 9999;top: 400px;right: 20px;
        }
        #deleteButton9 {
            position: absolute;z-index: 9999;top: 450px;right: 20px;
        }

        /*6ï¼šæœç´¢æŒ‰é’®*/
        #searchButton {
            position: absolute;
            z-index: 9999;
            top: 50px;
            right: 370px;
        }
        #searchButtonCluster {
            position: absolute;
            z-index: 9999;
            top: 80px;
            right: 370px;
        }

        /*7ï¼šæ¸…ç©ºæŒ‰é’®*/
        #clearButton {
            position: absolute;
            z-index: 9999;
            top: 20px;
            right: 20px;
        }
    </style>
</head>



<body>
<!-- 1 åœ°å›¾å®¹å™¨ -->
<div id="container" class="map" tabindex="0"></div>

<!-- 2 æœç´¢æ¡†å®¹å™¨ -->
<div id="pickerBox">
    <input id="pickerInput" placeholder="è¾“å…¥å…³é”®å­—é€‰å–åœ°ç‚¹" value=""/>
    <div id="poiInfo"></div>
</div>
<!-- 2.5 æ¸…ç©ºæœç´¢æ¡† -->
<button id="clearSearchBox" onclick="clearSearchBox()"><i>æ¸…ç©º</i></button>

<!-- 3 æ·»åŠ æŒ‰é’®å®¹å™¨ -->
<button id="addButton" onclick="addPoi()"><i>æ·»åŠ è¯¥åœ°ç‚¹</i></button>

<!-- 4 ä¹ä¸ªåœ°å€æ å®¹å™¨ -->
<div><i id="poiContainer1"></i></div>
<div><i id="poiContainer2"></i></div>
<div><i id="poiContainer3"></i></div>
<div><i id="poiContainer4"></i></div>
<div><i id="poiContainer5"></i></div>
<div><i id="poiContainer6"></i></div>
<div><i id="poiContainer7"></i></div>
<div><i id="poiContainer8"></i></div>
<div><i id="poiContainer9"></i></div>

<!-- 5 ä¹ä¸ªåˆ é™¤æŒ‰é’®å®¹å™¨ -->
<button id="deleteButton1" onclick="deletePoi(1)"><i>åˆ é™¤</i></button>
<button id="deleteButton2" onclick="deletePoi(2)"><i>åˆ é™¤</i></button>
<button id="deleteButton3" onclick="deletePoi(3)"><i>åˆ é™¤</i></button>
<button id="deleteButton4" onclick="deletePoi(4)"><i>åˆ é™¤</i></button>
<button id="deleteButton5" onclick="deletePoi(5)"><i>åˆ é™¤</i></button>
<button id="deleteButton6" onclick="deletePoi(6)"><i>åˆ é™¤</i></button>
<button id="deleteButton7" onclick="deletePoi(7)"><i>åˆ é™¤</i></button>
<button id="deleteButton8" onclick="deletePoi(8)"><i>åˆ é™¤</i></button>
<button id="deleteButton9" onclick="deletePoi(9)"><i>åˆ é™¤</i></button>

<!-- 6 æœç´¢æŒ‰é’®å®¹å™¨ -->
<button id="searchButton" onclick="search()"><i>æœç´¢æœ€çŸ­è·¯å¾„</i></button>
<!-- 6.5 èšç±»æœç´¢è·¯å¾„-->
<button id="searchButtonCluster" onclick="alertCluster()"><i>èšç±»ï¼ˆåˆ†ç»„ï¼‰</i></button>

<!-- 7 æ¸…ç©ºåœ°ç‚¹ -->
<button id="clearButton" onclick="clearPois()"><i>æ¸…ç©ºæ‰€æœ‰åœ°ç‚¹</i></button>



<!-- è°ƒç”¨ JS API -->
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.8&key=4e8abd261bb57fbaeffc6756e3e7f8c3"></script>
<!-- UIç»„ä»¶åº“ -->
<script src="//webapi.amap.com/ui/1.1/main.js?v=1.1.1"></script>
<!-- è·¯çº¿æ˜¾ç¤º -->
<script src="https://webapi.amap.com/maps?v=1.4.15&key=4e8abd261bb57fbaeffc6756e3e7f8c3&plugin=AMap.Driving"></script>




<!-- Javascript -->
<script type="text/javascript">
    var totalPoiNum = 0; // 0 to 9
    var currentPoiInfo = ""; // current position information
    var currentPoiInfoDisplay = "";
    var positionsInfo = ""; // concatenated string of positions to RETURN
    var cluster = 0; // 0 = shorted path, >0 = cluster

    // Constructor of Position Information Boxes
    function createNode () {
        this.info = null;
        this.infoDisplay = null;
        this.nextNode = null;
        this.prevNode = null;
    }
    // Construct Position Information Box Objects in Node Data-structure
    var dummyFirstNode = new createNode();
    var lastNode = dummyFirstNode;

    // ç”Ÿæˆåœ°å›¾
    var map = new AMap.Map('container', {
        zoom: 10
    });
    AMapUI.loadUI(['misc/PoiPicker'], function(PoiPicker) {

        var poiPicker = new PoiPicker({
            //city:'åŒ—äº¬',
            input: 'pickerInput'
        });

        //åˆå§‹åŒ–poiPicker
        poiPickerReady(poiPicker);
    });
    function poiPickerReady(poiPicker) {

        window.poiPicker = poiPicker;

        var marker = new AMap.Marker();

        var infoWindow = new AMap.InfoWindow({
            offset: new AMap.Pixel(0, -20)
        });

        //é€‰å–äº†æŸä¸ªPOI
        poiPicker.on('poiPicked', function(poiResult) {

            var source = poiResult.source,
                poi = poiResult.item,
                // POI information
                info = {
                    id: poi.id,
                    name: poi.name,
                    location: poi.location.toString(),
                    address: poi.address
                };
                info2 = {
                    name: poi.name,
                    location: poi.location,
                    address: poi.address
                }

            marker.setMap(map);
            marker.setPosition(poi.location); // å›¾é’‰
            infoWindow.setMap(map);
            infoWindow.setPosition(poi.location); // POIä¿¡æ¯æ¡†

            // æ‰“å°ä¿¡æ¯
            //infoWindow.setContent('POIä¿¡æ¯: <pre>' + JSON.stringify(info, null, 2) + '</pre>');
            infoWindow.open(map, marker.getPosition());

            // current POI info
            currentPoiInfo = JSON.stringify(info, null);
            var name = info2.name;
            var address = info2.address;
            currentPoiInfoDisplay = name + ", " + address;
            document.getElementById("pickerInput").value = name; // fill poi name to search box

            map.setZoomAndCenter(14, info2.location); // reset map center & scale
        });

        //æœç´¢æ¨è
        poiPicker.onCityReady(function() {
            //poiPicker.suggest('ç¾é£Ÿ');
        });
    }

    // 2.5: clearSearchBox
    function clearSearchBox() {
        document.getElementById("pickerInput").value = "";
    }


    // ç‚¹å‡»æ·»åŠ åœ°ç‚¹åå½•å…¥å½“å‰POI
    function addPoi () {
        // Null Case
        if (totalPoiNum >= 9) {alert("è¯·å‹¿è¶…è¿‡ä¹ä¸ªç‚¹ï¼"); return;}

        // Null Case: é‡å¤åœ°ç‚¹
        var currentNode = dummyFirstNode;
        for (var index = 1; index <= totalPoiNum; index++) {
            currentNode = currentNode.nextNode;
            if (currentNode.infoDisplay == currentPoiInfoDisplay) {
                alert ("è¯·å‹¿è¾“å…¥ç›¸åŒåœ°ç‚¹ï¼");
                return;
            }
        }

        // Regular Case: js
        var newNode = new createNode();
        newNode.info = currentPoiInfo;
        newNode.infoDisplay = currentPoiInfoDisplay;
        newNode.prevNode = lastNode;
        lastNode.nextNode = newNode;
        lastNode = newNode;
        totalPoiNum++;

        // Regular Case: html
        connectPois();
    }

    function deletePoi (idxToDelete) {
        // Null Case: no poi info
        if (idxToDelete > totalPoiNum) {return;}

        // Regular Case
        totalPoiNum--;
        var currentNode = dummyFirstNode;
        for (var index = 1; index <= idxToDelete; index++) {
            currentNode = currentNode.nextNode;
        }
        currentNode.prevNode.nextNode = currentNode.nextNode;
        if (currentNode.nextNode != null) {
            currentNode.nextNode.prevNode = currentNode.prevNode;
        }
        // update HTML
        connectPois();

        // Update last node
        lastNode = dummyFirstNode;
        while (lastNode.nextNode != null) {
            lastNode = lastNode.nextNode;
        }
    }


    // æŠŠåœ°ç‚¹å†…å®¹æ”¾è¿›html
    function connectPois () {
        // Clear
        for (var index=1; index<10; index++) {
            document.getElementById("poiContainer" + index).innerText = "";
        }
        var currentNode = dummyFirstNode;
        var index = 1;
        while (index <= totalPoiNum) {
            currentNode = currentNode.nextNode;
            document.getElementById("poiContainer" + index).innerText = currentNode.infoDisplay;
            index++;
        }
        while (index <= 9) {
            document.getElementById("poiContainer" + index).innerText = "";
            index++;
        }
    }


    // 6ï¼šç‚¹å‡»æœç´¢æŒ‰é’®å‘åå°ä¼ å‚
    function search() {
        positionsInfo = "";
        // Null Case: 0/1 poi
        if (totalPoiNum < 2) {alert("è¯·è¾“å…¥è‡³å°‘ä¸¤ä¸ªåœ°ç‚¹ï¼"); return;}

        // Regular Case: concatenate infos
        var currentNode = dummyFirstNode;
        while (currentNode.nextNode != null) {
            currentNode = currentNode.nextNode;
            positionsInfo += currentNode.info;
        }
        document.getElementById("positionsToReturn").value = positionsInfo;
        document.getElementById("cluster").value = cluster;
        var form = document.getElementById("pois");
        form.submit();
    }

    // 6.5: Search Cluster
    function alertCluster() {
        cluster = prompt("è¯·è¾“å…¥åˆ†ç»„çš„ä¸ªæ•°ï¼š");
        // cluster > 0, cluster <= totalPoiNum
        if (cluster > 0 && cluster <= totalPoiNum) {
            search();
        }
        else {
            alert("è¯·è¾“å…¥å¤§äºé›¶ä¸”ä¸å¤§äºåœ°ç‚¹æ€»æ•°çš„æ•´æ•°ï¼")
            alertCluster();
        }
    }


    // 7ï¼šæ¸…ç©ºæ‰€æœ‰åœ°ç‚¹
    function clearPois() {
        totalPoiNum = 0;
        dummyFirstNode.nextNode = null;
        lastNode = dummyFirstNode;
        connectPois();
    }


    // æµ‹è¯•ç”¨çš„å‡½æ•°
    function alertPoi() {
        var currentNode = dummyFirstNode;
        while (currentNode.nextNode != null) {
            currentNode = currentNode.nextNode;
            alert(currentNode.info);
        }
    }

    function separationDisplay() {
        var func_INFO = {{ FUNC }};
        if (func_INFO == 0) {
            alert("Successful!!! This should be removed after TESTING");
        } else if (func_INFO == -1) {
            alert("Error!!! This should be removed after TESTING");
        } else if (func_INFO == 1) {
            shortestPathDisplay();
        } else if (func_INFO == 2) {
            clusteringDisplay();
        } else {
            alert("ERRORING IN FUNC INFO This should be removed after TESTING");
        }
    }

    window.onload = separationDisplay();

    //  ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER ğŸ‘‡ CLUSTER
    var center = null;
    var centerText = null;
    var setFitViewBtn = null;
    function clusteringDisplay() {

        var pic1 = "{% static 'img/map_icon/1.png' %}";
        var pic2 = "{% static 'img/map_icon/2.png' %}";
        var pic3 = "{% static 'img/map_icon/3.png' %}";
        var pic4 = "{% static 'img/map_icon/4.png' %}";
        var pic5 = "{% static 'img/map_icon/5.png' %}";
        var pic6 = "{% static 'img/map_icon/6.png' %}";
        var pic7 = "{% static 'img/map_icon/7.png' %}";
        var pic8 = "{% static 'img/map_icon/8.png' %}";
        var pic9 = "{% static 'img/map_icon/9.png' %}";
        var icon_lst = [pic1, pic2, pic3, pic4, pic5, pic6, pic7, pic8, pic9];

        // Location List
        var loc_lst = '{{ Locs }}';
        loc_lst = eval(loc_lst);
        // Result Diction
        var result_diction = '{{ Paths }}';
        result_diction = JSON.parse(result_diction.replace(/&quot;/g,'"'));

        function cluster_test() {
            map.clearMap();  // æ¸…é™¤åœ°å›¾è¦†ç›–ç‰©
            var markers = [];
            for (i = 0; i < Object.keys(result_diction).length; i++) {
                for (j = 0; j < result_diction[i].length; j++) {
                    markers.push({
                        icon: icon_lst[i],
                        position: loc_lst[result_diction[i][j]]
                    });
                };
            };
            // æ·»åŠ ä¸€äº›åˆ†å¸ƒä¸å‡çš„ç‚¹åˆ°åœ°å›¾ä¸Š,åœ°å›¾ä¸Šæ·»åŠ nä¸ªç‚¹æ ‡è®°ï¼Œä½œä¸ºå‚ç…§
            markers.forEach(function(marker) {
                new AMap.Marker({
                    map: map,
                    icon: marker.icon,
                    position: [marker.position[0], marker.position[1]],
                    offset: new AMap.Pixel(-13, -30)
                });
            });
            center = map.getCenter();
            centerText = 'å½“å‰ä¸­å¿ƒç‚¹åæ ‡ï¼š' + center.getLng() + ',' + center.getLat();
            document.getElementById('centerCoord').innerHTML = centerText;
            document.getElementById('tips').innerHTML = 'æˆåŠŸæ·»åŠ ä¸‰ä¸ªç‚¹æ ‡è®°ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªåœ¨å½“å‰åœ°å›¾è§†é‡å¤–ï¼';

            setFitViewBtn = document.getElementById('setFitView');
        }
        cluster_test();
        fit_view_quick();
    }

    // æ·»åŠ äº‹ä»¶ç›‘å¬, ä½¿åœ°å›¾è‡ªé€‚åº”æ˜¾ç¤ºåˆ°åˆé€‚çš„èŒƒå›´
    function fit_view_quick() {
        // ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç©ºï¼Œè¡¨æ˜ç”¨å›¾ä¸Šæ‰€æœ‰è¦†ç›–ç‰© setFitview
        // ç¬¬äºŒä¸ªå‚æ•°ä¸ºfalse, éç«‹å³æ‰§è¡Œ
        // ç¬¬ä¸‰ä¸ªå‚æ•°è®¾ç½®ä¸Šå·¦ä¸‹å³çš„ç©ºç™½
        map.setFitView(null, false, [150, 60, 100, 60]);
        var newCenter = map.getCenter();
        document.getElementById('centerCoord').innerHTML = 'å½“å‰ä¸­å¿ƒç‚¹åæ ‡ï¼š' + newCenter.toString();
        document.getElementById('tips').innerHTML = 'é€šè¿‡setFitViewï¼Œåœ°å›¾è‡ªé€‚åº”æ˜¾ç¤ºåˆ°åˆé€‚çš„èŒƒå›´å†…,ç‚¹æ ‡è®°å·²å…¨éƒ¨æ˜¾ç¤ºåœ¨è§†é‡ä¸­ï¼';
    };
    //  ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER ğŸ‘† CLUSTER
    // ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST ğŸ‘‡ SHORTEST
    function shortestPathDisplay(){
        var location_lst = eval('{{ Locs }}'); // TEST CASE: [[90.427281, 30.865042], [110.427281, 30.865042], [80.379028, 30.865042], [80.379028, 39.903719], [79.379028, 39.903719], [79.379028, 40.903719]]
        var order_lst = eval('{{ Paths }}'); // TEST CASE: [0, 1, 2, 3, 4, 5];

        var drivingOption = {
            policy: AMap.DrivingPolicy.LEAST_TIME, // å…¶å®ƒpolicyå‚æ•°è¯·å‚è€ƒ https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingPolicy
            ferry: 1, // æ˜¯å¦å¯ä»¥ä½¿ç”¨è½®æ¸¡
            province: 'äº¬', // è½¦ç‰Œçœä»½çš„æ±‰å­—ç¼©å†™
        }

        // æ„é€ è·¯çº¿å¯¼èˆªç±»
        var driving = new AMap.Driving(drivingOption)

        var pre_order_lst = [];
        for (var order_lst_i = 0; order_lst_i < order_lst.length - 1; order_lst_i++) {
            pre_order_lst.push([location_lst[order_lst[order_lst_i]][0], location_lst[order_lst[order_lst_i]][1], location_lst[order_lst[order_lst_i + 1]][0], location_lst[order_lst[order_lst_i + 1]][1]]);
        }

        function return_index(json_result) {
            var result_tuple = [json_result.origin.lng, json_result.origin.lat, json_result.destination.lng, json_result.destination.lat];
            var order_x = 0;
            for (var order_i = 0; order_i < pre_order_lst.length; order_i++) {
                if (pre_order_lst[order_i][0] == result_tuple[0] && pre_order_lst[order_i][1] == result_tuple[1] && pre_order_lst[order_i][2] == result_tuple[2] && pre_order_lst[order_i][3] == result_tuple[3]) {
                    order_x = order_i;
                    break;
                }
            }
            return order_x
        }

        for (var order_i = 1; order_i < order_lst.length; order_i++) {
            // æ ¹æ®èµ·ç»ˆç‚¹ç»çº¬åº¦è§„åˆ’é©¾è½¦å¯¼èˆªè·¯çº¿
            var func_status = function(status, result) {
                // resultå³æ˜¯å¯¹åº”çš„é©¾è½¦å¯¼èˆªä¿¡æ¯ï¼Œç›¸å…³æ•°æ®ç»“æ„æ–‡æ¡£è¯·å‚è€ƒ https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingResult
                if (status === 'complete') {
                    if (result.routes && result.routes.length) {
                        // ç»˜åˆ¶ç¬¬ä¸€æ¡è·¯çº¿ï¼Œä¹Ÿå¯ä»¥æŒ‰éœ€æ±‚ç»˜åˆ¶å…¶å®ƒå‡ æ¡è·¯çº¿
                        var color_number = return_index(result);
                        drawRoute(result.routes[0], color_number);
                        log.success('ç»˜åˆ¶é©¾è½¦è·¯çº¿å®Œæˆ');
                    }
                } else {
                    log.error('è·å–é©¾è½¦æ•°æ®å¤±è´¥ï¼š' + result)
                }
            }
            driving.search(new AMap.LngLat(location_lst[order_lst[order_i-1]][0], location_lst[order_lst[order_i-1]][1]), new AMap.LngLat(location_lst[order_lst[order_i]][0], location_lst[order_lst[order_i]][1]), func_status);
        }

        function drawRoute (route, color_num) {
            var path_color_lst = [['#ef4136', '#f7acbc'], ['#2b4490', '#33a3dc'], ['#f58220', '#fab27b'], ['#84bf96', '#cde6c7'], ['#ef5b9c', '#feeeed'], ['#33a3dc', '#90d7ec'], ['#ffd400', '#fcf16e'], ['#8552a1', '#afb4db'], ['#005831', '#45b97c']];

            // è§£æDrivingRouteå¯¹è±¡ï¼Œæ„é€ æˆAMap.Polylineçš„pathå‚æ•°éœ€è¦çš„æ ¼å¼
            // DrivingResultå¯¹è±¡ç»“æ„å‚è€ƒæ–‡æ¡£ https://lbs.amap.com/api/javascript-api/reference/route-search#m_DriveRoute
            function parseRouteToPath(route) {
                var path = []
                for (var i = 0, l = route.steps.length; i < l; i++) {
                    var step = route.steps[i]
                    for (var j = 0, n = step.path.length; j < n; j++) {
                      path.push(step.path[j])
                    }
                }
                return path
            }

            var path = parseRouteToPath(route)

            var icon_start_http = 'https://webapi.amap.com/theme/v1.3/markers/' + (color_num + 1) + '.png';
            var icon_end_http = 'https://webapi.amap.com/theme/v1.3/markers/' + (color_num + 2) + '.png';

            var startMarker = new AMap.Marker({
                position: path[0],
                icon: icon_start_http, // 'https://webapi.amap.com/theme/v1.3/markers/n/start.png',
                map: map
            })

            var endMarker = new AMap.Marker({
                position: path[path.length - 1],
                icon: icon_end_http, // https://webapi.amap.com/theme/v1.3/markers/n/end.png',
                map: map
            })

            var routeLine = new AMap.Polyline({
                path: path,
                isOutline: true,
                outlineColor: path_color_lst[color_num][1],
                borderWeight: 2,
                strokeWeight: 5,
                strokeColor: path_color_lst[color_num][0],
                lineJoin: 'round'
            })

            routeLine.setMap(map)
            // è°ƒæ•´è§†é‡è¾¾åˆ°æœ€ä½³æ˜¾ç¤ºåŒºåŸŸ
            map.setFitView([ startMarker, endMarker, routeLine ])
        }
    }
    // ğŸ‘† SHORTEST ğŸ‘† SHORTEST ğŸ‘† SHORTEST ğŸ‘† SHORTEST ğŸ‘† SHORTEST ğŸ‘† SHORTEST ğŸ‘† SHORTEST ğŸ‘† SHORTEST
</script>


<form action="tested" method="post" id="pois">{% csrf_token %}
    <input type="hidden" id="positionsToReturn" name="positionsToReturn" value="">
    <input type="hidden" id="cluster" name="cluster" value="">
</form>

</body>

</html>
